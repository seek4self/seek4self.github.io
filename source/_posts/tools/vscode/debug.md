---
title: VSCode 调试 c++ 配置
top: true
cover: false
toc: true
mathjax: false
date: 2021-06-11 21:17:01
password:
summary: 像 IDE 一样使用 VSCode 
categories: tools
tags: 
  - vscode
  - c++
  - debug
---

自从微软出了 VSCode 编辑器后，就没在使用其他 IDE 了，用来编写一些动态语言(Node.js、Python)程序，不需要编译，安装的相关插件能很好的帮助调试。但是对于 c++ 这种静态编译语言，调试就成了一个大麻烦，环境配置都很难顺利的走下去，正好准备用 VSCode 看 SRS 源码，将相关的 c++ 配置及调试过程记录一下。

环境基于 WSL-Ubuntu 20.04

## 准备工作

1. 必要的 c++ 环境程序，安装过程不会的自行 Google 吧
   - gcc/g++
   - make/cmake
   - gdb
2. 需要安装 VSCode 插件
   - `C/C++` (c/c++ 语法)
   - `C++ Intellisense` (代码格式化)
   - `CMake` (cmake 语法高亮)
   - `CMake Tools`

## 编译调试

CMake 编译需要写 CMakeLists.txt 文件， make 需要 Makefile 文件， 根据需要自行选择，这里以 CMake 为例

### 添加配置

#### CMake

按快捷键 `Ctrl+Shift+P` 调出控制台， 输入 `cmake` ，选择`CMake:Configure` 或者 `CMake:Quick Start` 开始配置

1. 选择 gcc 编译工具版本

    ![select gcc](https://cdn.jsdelivr.net/gh/seek4self/imgbed@main/img/blog/vscode/cmake/cmake.png)

2. 根据提示创建 `CMakeLists.txt`， 选择 `Create`， 创建新文件， 选择`Locate` 打开已有文件

    ![create CMakeLists.txt](https://cdn.jsdelivr.net/gh/seek4self/imgbed@main/img/blog/vscode/cmake/cmake_configure.pn)

3. 若 2 选择`Create`, 则按提示创建文件，输入项目名称，选择输出类型，就会生成 `CMakeLists.txt` 文件, 根据需要配置相关项，参考[CMakeLists.txt 实例](#cmakeliststxt-实例)

    ![input project name](https://cdn.jsdelivr.net/gh/seek4self/imgbed@main/img/blog/vscode/cmake/cmake_project.png)  
    ![select output](https://cdn.jsdelivr.net/gh/seek4self/imgbed@main/img/blog/vscode/cmake/cmake_out.png)

当状态栏出现如下图表时，则表明配置完成，可以选择 `Build` 尝试编译

![build status](https://cdn.jsdelivr.net/gh/seek4self/imgbed@main/img/blog/vscode/cmake/cmake_status.png)

#### CMakeLists.txt 实例

该配置是使用`pkgconfig`编译成动态库， 如需其他格式，自行修改

```cmake
cmake_minimum_required(VERSION 3.5)

# 使用 pkgconfig 导入第三方库
project(decoder LANGUAGES C)
set(ENV{PKG_CONFIG_PATH} /usr/local/ffmpeg/lib/pkgconfig)
find_package(PkgConfig)
pkg_check_modules(FFMPEG REQUIRED libavcodec libavformat libavutil)
message('sss',${FFMPEG_INCLUDE_DIRS})
include_directories(${FFMPEG_INCLUDE_DIRS})
link_directories(${FFMPEG_LIBRARY_DIRS})

# 显式指定编译器
set(CMAKE_C_COMPILER "gcc")
 
# 开启调试信息
set(CMAKE_BUILD_TYPE "Debug")
set(CMAKE_C_FLAGS_DEBUG "$ENV{CFLAGS} -O0 -Wall -g2 -ggdb")
set(CMAKE_C_FLAGS_RELEASE "$ENV{CFLAGS} -O3 -Wall")
 
 
# 开启所有警告
set(CMAKE_C_FLAGS "-Wall")

add_executable(mediainfo mediainfo.c)
target_link_libraries(mediainfo ${FFMPEG_LIBRARIES})

add_executable(extra_audio extra_audio.c)
target_link_libraries(extra_audio ${FFMPEG_LIBRARIES})

```

### Debug

设置好 CMake 后，打开 `.cpp` 文件， 按快捷键 `Ctrl+Shift+D` 打开调试面板，点击 `运行和调试`, 根据系统情况选取不同的 `C++` ,如下图所示：

![select environment](https://cdn.jsdelivr.net/gh/seek4self/imgbed@main/img/blog/vscode/cmake/debug.png)

然后根据需要选择不同版本的编译器配置，会生成 `launch.json` 和 `tasks.json`, 根据调试需求更改相应的参数

![select complier config](https://cdn.jsdelivr.net/gh/seek4self/imgbed@main/img/blog/vscode/cmake/debug_g++.png)

下面以提供调试启动配置实例, 详细配置请参考[官方文档](https://code.visualstudio.com/docs/cpp/config-wsl)

- task.json

```json
{
    "tasks": [
        {  // 默认生成的配置，用于编译单个C++可行，但是大项目就需要其他配置了，可以不用管,
            "type": "cppbuild",
            "label": "C/C++: gcc-9 build active file",
            "command": "/usr/bin/gcc-9",
            "args": [
                "-g",
                "${workspaceFolder}/main.c",
                "-o",
                "${fileDirname}/${fileBasenameNoExtension}"
            ],
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "problemMatcher": [
                "$gcc"
            ],
            "group": {
                "kind": "build",
                "isDefault": true
            },
            "detail": "Task generated by Debugger."
        },
        // 这个任务配置对于小项目来说修改完直接编译调试还不错，
        // 但是大项目最好手动编译好后，直接使用 launch 调试，不建议用 task 配置 
        {
            // label 是 task 唯一标识， 对应下面 launch 的 preLaunchTask 配置
            "label": "cmake",
            "type": "shell",
            "command": "cmake",
            "args": [
                "../"
            ],
            "options": {
                // 工作目录
                "cwd": "${workspaceFolder}/build"
            }
        },
        {
            "label": "make",
            "type": "shell",
            "command": "make",
            "options": {
                "cwd": "${workspaceFolder}/build"
            }
        },
        {
            "label": "build",
            // dependsOn 按顺序执行多个 task
            "dependsOn": [
                "cmake",
                "make"
            ]
        }
    ],
    "version": "2.0.0"
}
```

- launch.json

```json
{
    // 使用 IntelliSense 了解相关属性。 
    // 悬停以查看现有属性的描述。
    // 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "name": "gdb launch",
            "type": "cppdbg",
            "request": "launch",
            // program 是调试启动可执行文件路径 
            "program": "${workspaceFolder}/build/decoder",
            // args 将照命令行参数以空格分割，顺序依次写入数组列表，
            "args": [
                "/mnt/e/film/Fate_Zero_all_OP_and_ED.mp4",
                "output"
            ],
            "stopAtEntry": false,
            "cwd": "${workspaceFolder}",
            "environment": [],
            "externalConsole": false,
            // preLaunchTask 调试启动前置任务，需要配置 task.json, 进行一些编译任务
            "preLaunchTask": "build",
            "miDebuggerPath": "/usr/bin/gdb",
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "为 gdb 启用整齐打印",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                }
            ]
        }
    ]
}
```

设置好后就可以愉快的 `F5` 了

### C++ 插件配置

该配置可以解决阅读源码时导入第三方文件报红线错误，以及一些自定义 C++ 的配置

按快捷键 `Ctrl+Shift+P` 调出控制台, 输入 `c++`，选择 `C/C++编辑配置` UI界面或者 JSON 格式进行配置 `c_cpp_properties.json`，

```json
{
    "configurations": [
         {
            "name": "Linux",
            // add header file path
            "includePath": [
                "${workspaceFolder}/**",
                "/usr/local/ffmpeg/include"
            ],
            "defines": [],
            // set search path
            "browse": {
                "path": [
                    "/usr/local/ffmpeg/include",
                    "${workspaceFolder}"
                ],
                "limitSymbolsToIncludedHeaders": false
            },
            "compilerPath": "/usr/bin/clang",
            "cStandard": "c11",
            "cppStandard": "c++14",
            "intelliSenseMode": "clang-x64",
            "compileCommands": "${workspaceFolder}/build/compile_commands.json",
            "configurationProvider": "ms-vscode.cmake-tools"
        }
    ],
    "version": 4
}
```

### 多线程调试

当调试 SRS 多线程程序时， 因为有守护进程，VSCode 调试没有自动跟踪子线程，在父线程就退出了,可以在 `launch.json` 中添加强制跟踪子线程的配置，

- launch.json

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            ...
            "setupCommands": [
                {
                    // 设置跟踪子进程
                    "text": "-gdb-set follow-fork-mode child"
                }
            ]
        }
    ]
}
```
